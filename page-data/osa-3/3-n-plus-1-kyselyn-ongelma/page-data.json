{"componentChunkName":"component---src-templates-course-content-template-js","path":"/osa-3/3-n-plus-1-kyselyn-ongelma","result":{"data":{"page":{"htmlAst":{"type":"element","tagName":"div","properties":{},"children":[{"type":"element","tagName":"text-box","properties":{"variant":"learningObjectives","name":"Oppimistavoitteet"},"children":[{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Tiedät mitä N+1 -kyselyn ongelma tarkoittaa."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Osaat antaa esimerkkejä tilanteista, joissa N+1 -kyselyn ongelma voi esiintyä."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Tunnet menetelmiä N+1 -kyselyn ongelman kiertämiseen."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Tunnet tietokantakyselyiden ohjeistamiseen käytetyt annotaatiot "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"@EntityGraph"}]},{"type":"text","value":" ja "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"@NamedEntityGraph"}]},{"type":"text","value":" ja olet kokeillut niiden käyttöä."}]},{"type":"text","value":"\n"}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Tietokanta-abstraktioita tarjoavat kirjastot päättävät miten haettavaan olioon liittyvät viitteet haetaan. Perinteisesti tähän on ollut käytössä kaksi vaihtoehtoa: (1) haetaan viitatut oliot samalla kun viittaavaa oliota haetaan, ja (2) hakea viitatut oliot vasta kun niitä pyydetään eksplisiittisesti esimerkiksi olion get-metodin kautta."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Viitattujen olioiden lataaminen vasta niitä tarvittaessa on yleisesti ottaen hyvä idea, mutta sillä on myös kääntöpuolensa."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Pohditaan pankkijärjestelmäämme, missä henkilöllä voi olla monta tiliä, ja yhdellä tilillä voi olla monta omistajaa — "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"@ManyToMany"}]},{"type":"text","value":"."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Luodaan sovellukseen sivu, joka tulostaa jokaisen tilin yhteydessä tilin omistajien lukumäärän. Kontrollerin puolella toteutus on helppo — haemme tilit tietokannasta ja lisäämme ne modeliin."}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"java"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-java"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-java"]},"children":[{"type":"text","value":"model"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"."}]},{"type":"element","tagName":"span","properties":{"className":["token","function"]},"children":[{"type":"text","value":"addAttribute"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"tilit\""}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]},{"type":"text","value":" tiliRepository"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"."}]},{"type":"element","tagName":"span","properties":{"className":["token","function"]},"children":[{"type":"text","value":"findAll"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":";"}]}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"HTML-sivullakin toteutus on suhteellisen suoraviivainen."}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"html"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-html"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-html"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","tag"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","tag"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"<"}]},{"type":"text","value":"h1"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":">"}]}]},{"type":"text","value":"Tilit"},{"type":"element","tagName":"span","properties":{"className":["token","tag"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","tag"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"</"}]},{"type":"text","value":"h1"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":">"}]}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","tag"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","tag"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"<"}]},{"type":"text","value":"ul"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":">"}]}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","tag"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","tag"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"<"}]},{"type":"text","value":"li"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","attr-name"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","namespace"]},"children":[{"type":"text","value":"th:"}]},{"type":"text","value":"each"}]},{"type":"element","tagName":"span","properties":{"className":["token","attr-value"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","punctuation","attr-equals"]},"children":[{"type":"text","value":"="}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"\""}]},{"type":"text","value":"tili: ${tilit}"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"\""}]}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":">"}]}]},{"type":"text","value":"\n        "},{"type":"element","tagName":"span","properties":{"className":["token","tag"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","tag"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"<"}]},{"type":"text","value":"a"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","attr-name"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","namespace"]},"children":[{"type":"text","value":"th:"}]},{"type":"text","value":"href"}]},{"type":"element","tagName":"span","properties":{"className":["token","attr-value"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","punctuation","attr-equals"]},"children":[{"type":"text","value":"="}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"\""}]},{"type":"text","value":"@{/tilit/{id}(id=${tili.id})}"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"\""}]}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":">"}]}]},{"type":"text","value":"\n            Tili: "},{"type":"element","tagName":"span","properties":{"className":["token","tag"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","tag"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"<"}]},{"type":"text","value":"span"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","attr-name"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","namespace"]},"children":[{"type":"text","value":"th:"}]},{"type":"text","value":"text"}]},{"type":"element","tagName":"span","properties":{"className":["token","attr-value"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","punctuation","attr-equals"]},"children":[{"type":"text","value":"="}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"\""}]},{"type":"text","value":"${tili.id}"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"\""}]}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":">"}]}]},{"type":"text","value":"tilin id"},{"type":"element","tagName":"span","properties":{"className":["token","tag"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","tag"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"</"}]},{"type":"text","value":"span"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":">"}]}]},{"type":"text","value":",\n            Saldo: "},{"type":"element","tagName":"span","properties":{"className":["token","tag"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","tag"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"<"}]},{"type":"text","value":"span"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","attr-name"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","namespace"]},"children":[{"type":"text","value":"th:"}]},{"type":"text","value":"text"}]},{"type":"element","tagName":"span","properties":{"className":["token","attr-value"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","punctuation","attr-equals"]},"children":[{"type":"text","value":"="}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"\""}]},{"type":"text","value":"${tili.saldo}"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"\""}]}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":">"}]}]},{"type":"text","value":"saldo"},{"type":"element","tagName":"span","properties":{"className":["token","tag"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","tag"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"</"}]},{"type":"text","value":"span"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":">"}]}]},{"type":"text","value":",\n            Omistajia "},{"type":"element","tagName":"span","properties":{"className":["token","tag"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","tag"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"<"}]},{"type":"text","value":"span"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","attr-name"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","namespace"]},"children":[{"type":"text","value":"th:"}]},{"type":"text","value":"text"}]},{"type":"element","tagName":"span","properties":{"className":["token","attr-value"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","punctuation","attr-equals"]},"children":[{"type":"text","value":"="}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"\""}]},{"type":"text","value":"${tili.omistajat.size()}"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"\""}]}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":">"}]}]},{"type":"text","value":"lukumäärä"},{"type":"element","tagName":"span","properties":{"className":["token","tag"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","tag"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"</"}]},{"type":"text","value":"span"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":">"}]}]},{"type":"text","value":"\n        "},{"type":"element","tagName":"span","properties":{"className":["token","tag"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","tag"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"</"}]},{"type":"text","value":"a"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":">"}]}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","tag"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","tag"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"</"}]},{"type":"text","value":"li"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":">"}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","tag"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","tag"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"</"}]},{"type":"text","value":"ul"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":">"}]}]}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Kun haemme kontrollerissa tilit, sovellus tekee yhden tietokantakyselyn. Kun tulostamme tiliin liittyvien omistajien lukumäärän, tulee omistajat hakea. Tämä tehdään tilikohtaisesti "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"th:each=\"tili: ${tilit}\""}]},{"type":"text","value":", joten kyselyitä tehdään yksi jokaista tiliä kohden. Tätä ongelmaa, missä näennäisesti yksinkertainen tiedon näyttäminen paisuu isoksi joukoksi tietokantakyselyitä kutsutaan N+1 -kyselyn ongelmaksi — ongelmassa tehdään N-kyselyä alkuperäisen yhden kyselyn lisäksi."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Ongelman voi ratkaista useammalla tavalla:"}]},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Ensimmäinen ratkaisu on poistaa N+1 -kyselyn ongelman aiheuttava osa sovelluksestamme — kuinka tärkeää on näyttää tilin omistajien lukumäärä?"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Toinen ratkaisu on denormalisoida tietokantaa hieman, jolloin tauluun Tili lisättäisiin oma sarake omistajien lukumäärälle — tämä vaatisi uuden sarakkeen tiedon ylläpidot automaattisesti."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Kolmas ratkaisu on toteuttaa sivulle erillinen kysely, joka hakee sekä tilit että tilin omistajien lukumäärän — tietokanta-abstraktio ei tiedä että haluamme vain omistajien lukumäärän, joten se yrittää hakea kaikki tiedot; yksinkertainen yhteenvetokysely ajaisi täysin saman asian."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Neljäs vaihtoehto — joka on tulossa yhä suositummaksi — on käyttää ns. Entity Grapheja kyselyssä, joiden avulla voidaan määritellä tarkemmin mitä haetaan."}]},{"type":"text","value":"\n"}]},{"type":"element","tagName":"br","properties":{},"children":[]},{"type":"element","tagName":"div","properties":{},"children":[{"type":"text","value":"Sovelluksen ennenaikaiseen optimointiin ei kuitenkaan kannata käyttää aikaa — ongelmat kannattaa korjata sitä mukaa kun niitä kohdataan. "},{"type":"element","tagName":"a","properties":{"href":"https://en.wikipedia.org/wiki/Donald_Knuth","target":"_blank"},"children":[{"type":"text","value":"Knuthin"}]},{"type":"text","value":" sanoin, "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"Programmers waste enormous amounts of time thinking about, or worrying about, the speed of noncritical parts of their programs, and these attempts at efficiency actually have a strong negative impact when debugging and maintenance are considered. We should forget about small efficiencies, say about 97% of the time: premature optimization is the root of all evil. Yet we should not pass up our opportunities in that critical 3%."}]}]},{"type":"element","tagName":"br","properties":{},"children":[]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Miten sitten N+1 -kyselyn oikein tunnistaa ohjelmasta? Yksinkertaisin tapa on tarkastella tietokantaan tehtyjä kyselyitä. Spring tulostaa konsoliin käytetyt SQL-kyselyt kun lisäämällä projektin kansiossa "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"src/main/resources"}]},{"type":"text","value":" olevaan konfiguraatiotiedostoon "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"application.properties"}]},{"type":"text","value":" seuraavan rivin."}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"text"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-text"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"spring.jpa.show-sql=true"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Nyt, kun sovellus on käynnissä, sovelluksessa tehdyt tietokantakyselyt tulostetaan ohjelman lokiin. Esimerkiksi yllä olevan sivun hakeminen tuottaa lokiin seuraavanlaiset kyselyt — esimerkissämme tietokannassa on neljä tiliä:"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"text"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-text"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"Hibernate: select tili0_.id as id1_4_, tili0_.pankki_id as pankki_i3_4_, tili0_.saldo as saldo2_4_ from tili tili0_\nHibernate: select omistajat0_.tilit_id as tilit_id2_1_0_, omistajat0_.omistajat_id as omistaja1_1_0_, henkilo1_.id as id1_0_1_, henkilo1_.nimi as nimi2_0_1_ from henkilo_tilit omistajat0_ inner join henkilo henkilo1_ on omistajat0_.omistajat_id=henkilo1_.id where omistajat0_.tilit_id=?\nHibernate: select omistajat0_.tilit_id as tilit_id2_1_0_, omistajat0_.omistajat_id as omistaja1_1_0_, henkilo1_.id as id1_0_1_, henkilo1_.nimi as nimi2_0_1_ from henkilo_tilit omistajat0_ inner join henkilo henkilo1_ on omistajat0_.omistajat_id=henkilo1_.id where omistajat0_.tilit_id=?\nHibernate: select omistajat0_.tilit_id as tilit_id2_1_0_, omistajat0_.omistajat_id as omistaja1_1_0_, henkilo1_.id as id1_0_1_, henkilo1_.nimi as nimi2_0_1_ from henkilo_tilit omistajat0_ inner join henkilo henkilo1_ on omistajat0_.omistajat_id=henkilo1_.id where omistajat0_.tilit_id=?\nHibernate: select omistajat0_.tilit_id as tilit_id2_1_0_, omistajat0_.omistajat_id as omistaja1_1_0_, henkilo1_.id as id1_0_1_, henkilo1_.nimi as nimi2_0_1_ from henkilo_tilit omistajat0_ inner join henkilo henkilo1_ on omistajat0_.omistajat_id=henkilo1_.id where omistajat0_.tilit_id=?"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Lokissa nähdään ensin tilien hakeminen, jota seuraa tilien hakeminen yksitellen. Syntaksi on automaattisesti luotua SQL:ää ja voi näyttää hieman monimutkaiselta — tarkemmin tarkasteltuna kysely muuttuu tutuksi."}]},{"type":"element","tagName":"h4","properties":{},"children":[{"type":"text","value":"EntityGraph"}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Edellä kuvattiin muutamia vaihtoehtoja N+1 -kyselyn ongelman poistamiseksi. Tarkastellaan tässä neljättä vaihtoehtoa eli entity grapheja, jotka esiteltiin vuonna 2013 julkaistussa JPA 2.1 standardissa. Entity graphien avulla ohjelmoija voi määritellä kyselyn tuloksena haettavat oliot ym. tiedot."}]},{"type":"element","tagName":"div","properties":{},"children":[{"type":"text","value":"Teemaan voi tarkemmin syventyä Spring Data JPA-projektin "},{"type":"element","tagName":"a","properties":{"href":"https://docs.spring.io/spring-data/jpa/docs/current/reference/html/","target":"_blank"},"children":[{"type":"text","value":"dokumentaatiossa"}]},{"type":"text","value":" sekä mm. osoitteissa "},{"type":"element","tagName":"a","properties":{"href":"https://www.baeldung.com/jpa-entity-graph","target":"_blank"},"children":[{"type":"text","value":"https://www.baeldung.com/jpa-entity-graph"}]},{"type":"text","value":" ja "},{"type":"element","tagName":"a","properties":{"href":"https://www.radcortez.com/jpa-entity-graphs/","target":"_blank"},"children":[{"type":"text","value":"https://www.radcortez.com/jpa-entity-graphs/"}]},{"type":"text","value":"."}]},{"type":"element","tagName":"br","properties":{},"children":[]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Voimme korvata "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"JpaRepository"}]},{"type":"text","value":"-luokan tarjoaman "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"findAll"}]},{"type":"text","value":"-toteutuksen omalla metodillamme. Alla olevassa toteutuksessa kerrotaan, että haluamme hakea tilien yhteydessä myös tilien "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"omistajat"}]},{"type":"text","value":"-muuttujaan liityvät tiedot."}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"java"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-java"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-java"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"public"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"interface"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","class-name"]},"children":[{"type":"text","value":"TiliRepository"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"extends"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","class-name"]},"children":[{"type":"text","value":"JpaRepository"}]},{"type":"element","tagName":"span","properties":{"className":["token","generics"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"<"}]},{"type":"element","tagName":"span","properties":{"className":["token","class-name"]},"children":[{"type":"text","value":"Tili"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","class-name"]},"children":[{"type":"text","value":"Long"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":">"}]}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"{"}]},{"type":"text","value":"\n\n    "},{"type":"element","tagName":"span","properties":{"className":["token","annotation","punctuation"]},"children":[{"type":"text","value":"@EntityGraph"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"text","value":"attributePaths "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"="}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"{"}]},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"omistajat\""}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"}"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","class-name"]},"children":[{"type":"text","value":"List"}]},{"type":"element","tagName":"span","properties":{"className":["token","generics"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"<"}]},{"type":"element","tagName":"span","properties":{"className":["token","class-name"]},"children":[{"type":"text","value":"Tili"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":">"}]}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","function"]},"children":[{"type":"text","value":"findAll"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":";"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"}"}]}]}]}]},{"type":"element","tagName":"br","properties":{},"children":[]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Kun tietokannasta tilit kutsulla "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"findAll"}]},{"type":"text","value":", sovellus hakee tilien yhteydessä myös omistajat."}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"text"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-text"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"Hibernate: select tili0_.id as id1_4_0_, henkilo2_.id as id1_0_1_, tili0_.pankki_id as pankki_i3_4_0_, tili0_.saldo as saldo2_4_0_, henkilo2_.nimi as nimi2_0_1_, omistajat1_.tilit_id as tilit_id2_1_0__, omistajat1_.omistajat_id as omistaja1_1_0__ from tili tili0_ left outer join henkilo_tilit omistajat1_ on tili0_.id=omistajat1_.tilit_id left outer join henkilo henkilo2_ on omistajat1_.omistajat_id=henkilo2_.id"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Mutta! (Ainakin Spring Bootin versiossa 2.1.3) Sovellus hakee nyt myös henkilöiden pankit, vaikkei niitä eksplisiittisesti tarvita. Edellinen muutos aiheuttaa jostain syystä uuden N+1 -kyselyn ongelman. Onneksi kyselyjen logitus oli päällä. Korjataan tilanne pienellä purkkaratkaisulla — pyydetään tilejä haettaessa myös tileihin liittyvät pankit."}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"java"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-java"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-java"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"public"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"interface"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","class-name"]},"children":[{"type":"text","value":"TiliRepository"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"extends"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","class-name"]},"children":[{"type":"text","value":"JpaRepository"}]},{"type":"element","tagName":"span","properties":{"className":["token","generics"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"<"}]},{"type":"element","tagName":"span","properties":{"className":["token","class-name"]},"children":[{"type":"text","value":"Tili"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","class-name"]},"children":[{"type":"text","value":"Long"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":">"}]}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"{"}]},{"type":"text","value":"\n\n    "},{"type":"element","tagName":"span","properties":{"className":["token","annotation","punctuation"]},"children":[{"type":"text","value":"@EntityGraph"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"text","value":"attributePaths "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"="}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"{"}]},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"omistajat\""}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"pankki\""}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"}"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","class-name"]},"children":[{"type":"text","value":"List"}]},{"type":"element","tagName":"span","properties":{"className":["token","generics"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"<"}]},{"type":"element","tagName":"span","properties":{"className":["token","class-name"]},"children":[{"type":"text","value":"Tili"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":">"}]}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","function"]},"children":[{"type":"text","value":"findAll"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":";"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"}"}]}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Nyt kysely hakee myös tileihin liittyvät pankit."}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"text"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-text"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"Hibernate: select tili0_.id as id1_4_0_, henkilo2_.id as id1_0_1_, pankki3_.id as id1_3_2_, tili0_.pankki_id as pankki_i3_4_0_, tili0_.saldo as saldo2_4_0_, henkilo2_.nimi as nimi2_0_1_, omistajat1_.tilit_id as tilit_id2_1_0__, omistajat1_.omistajat_id as omistaja1_1_0__, pankki3_.nimi as nimi2_3_2_ from tili tili0_ left outer join henkilo_tilit omistajat1_ on tili0_.id=omistajat1_.tilit_id left outer join henkilo henkilo2_ on omistajat1_.omistajat_id=henkilo2_.id left outer join pankki pankki3_ on tili0_.pankki_id=pankki3_.id"}]}]}]},{"type":"element","tagName":"h4","properties":{},"children":[{"type":"text","value":"NamedEntityGraph"}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Yllä olevassa esimerkissä korvasimme "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"JpaRepository"}]},{"type":"text","value":"-rajapinnan tarjoaman metodin. EntityGraphin voi määritellä myös osaksi entiteettiä annotaation "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"@NamedEntityGraph"}]},{"type":"text","value":" avulla. Yllä olevan kyselyn voi toteuttaa myös seuraavalla tavalla."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Alla luokalle "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"Tili"}]},{"type":"text","value":" on määritelty kysely "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"Tili.omistajatJaPankit"}]},{"type":"text","value":", joka hakee tilin haun yhteydessä omistajat ja pankit. Toiminnallisuus on käytännössä identtinen edellisen toteutuksemme kanssa."}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"java"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-java"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-java"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","annotation","punctuation"]},"children":[{"type":"text","value":"@NamedEntityGraph"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"text","value":"name "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"="}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"Tili.omistajatJaPankit\""}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]},{"type":"text","value":"\n  attributeNodes "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"="}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"{"}]},{"type":"element","tagName":"span","properties":{"className":["token","annotation","punctuation"]},"children":[{"type":"text","value":"@NamedAttributeNode"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"omistajat\""}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","annotation","punctuation"]},"children":[{"type":"text","value":"@NamedAttributeNode"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"pankki\""}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"}"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","annotation","punctuation"]},"children":[{"type":"text","value":"@Entity"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","annotation","punctuation"]},"children":[{"type":"text","value":"@Data"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","annotation","punctuation"]},"children":[{"type":"text","value":"@NoArgsConstructor"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","annotation","punctuation"]},"children":[{"type":"text","value":"@AllArgsConstructor"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"public"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"class"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","class-name"]},"children":[{"type":"text","value":"Tili"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"extends"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","class-name"]},"children":[{"type":"text","value":"AbstractPersistable"}]},{"type":"element","tagName":"span","properties":{"className":["token","generics"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"<"}]},{"type":"element","tagName":"span","properties":{"className":["token","class-name"]},"children":[{"type":"text","value":"Long"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":">"}]}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"{"}]},{"type":"text","value":"\n\n    "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"private"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","class-name"]},"children":[{"type":"text","value":"BigDecimal"}]},{"type":"text","value":" saldo "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"="}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"new"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","class-name"]},"children":[{"type":"text","value":"BigDecimal"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"0"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":";"}]},{"type":"text","value":"\n\n    "},{"type":"element","tagName":"span","properties":{"className":["token","annotation","punctuation"]},"children":[{"type":"text","value":"@ManyToOne"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"private"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","class-name"]},"children":[{"type":"text","value":"Pankki"}]},{"type":"text","value":" pankki"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":";"}]},{"type":"text","value":"\n\n    "},{"type":"element","tagName":"span","properties":{"className":["token","annotation","punctuation"]},"children":[{"type":"text","value":"@ManyToMany"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"text","value":"mappedBy "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"="}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"tilit\""}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"private"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","class-name"]},"children":[{"type":"text","value":"List"}]},{"type":"element","tagName":"span","properties":{"className":["token","generics"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"<"}]},{"type":"element","tagName":"span","properties":{"className":["token","class-name"]},"children":[{"type":"text","value":"Henkilo"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":">"}]}]},{"type":"text","value":" omistajat "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"="}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"new"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","class-name"]},"children":[{"type":"text","value":"ArrayList"}]},{"type":"element","tagName":"span","properties":{"className":["token","generics"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"<"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":">"}]}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":";"}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"}"}]}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Luokkaan "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"Tili"}]},{"type":"text","value":" määritellyn kyselyn käyttäminen tapahtuu "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"JpaRepository"}]},{"type":"text","value":"-rajapinnassa seuraavasti. Korvaamme yhä aiemman "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"findAll"}]},{"type":"text","value":"-metodin, mutta toisin kuin aiemmin, kerromme kyselyn sijaan kyselyn nimen eli "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"Tili.omistajatJaPankit"}]},{"type":"text","value":"."}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"java"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-java"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-java"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"public"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"interface"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","class-name"]},"children":[{"type":"text","value":"TiliRepository"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"extends"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","class-name"]},"children":[{"type":"text","value":"JpaRepository"}]},{"type":"element","tagName":"span","properties":{"className":["token","generics"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"<"}]},{"type":"element","tagName":"span","properties":{"className":["token","class-name"]},"children":[{"type":"text","value":"Tili"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","class-name"]},"children":[{"type":"text","value":"Long"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":">"}]}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"{"}]},{"type":"text","value":"\n\n    "},{"type":"element","tagName":"span","properties":{"className":["token","annotation","punctuation"]},"children":[{"type":"text","value":"@EntityGraph"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"text","value":"value "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"="}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"Tili.omistajatJaPankit\""}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","class-name"]},"children":[{"type":"text","value":"List"}]},{"type":"element","tagName":"span","properties":{"className":["token","generics"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"<"}]},{"type":"element","tagName":"span","properties":{"className":["token","class-name"]},"children":[{"type":"text","value":"Tili"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":">"}]}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","function"]},"children":[{"type":"text","value":"findAll"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":";"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"}"}]}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Tilanne ei ole vieläkään ihanteellinen, sillä korvaamme metodin "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"findAll"}]},{"type":"text","value":". Jossain muualla metodia saatetaan haluta käyttää ilman, että tilien hakemisen yhteydessä haetaan tilin omistajat ja pankit. Yksi vaihtoehto on toteuttaa erillinen metodi — vaikkapa "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"findByIdNotNull"}]},{"type":"text","value":" — joka ajaa saman asian."}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"java"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-java"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-java"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"public"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"interface"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","class-name"]},"children":[{"type":"text","value":"TiliRepository"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"extends"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","class-name"]},"children":[{"type":"text","value":"JpaRepository"}]},{"type":"element","tagName":"span","properties":{"className":["token","generics"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"<"}]},{"type":"element","tagName":"span","properties":{"className":["token","class-name"]},"children":[{"type":"text","value":"Tili"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","class-name"]},"children":[{"type":"text","value":"Long"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":">"}]}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"{"}]},{"type":"text","value":"\n\n    "},{"type":"element","tagName":"span","properties":{"className":["token","annotation","punctuation"]},"children":[{"type":"text","value":"@EntityGraph"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"text","value":"value "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"="}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"Tili.omistajatJaPankit\""}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","class-name"]},"children":[{"type":"text","value":"List"}]},{"type":"element","tagName":"span","properties":{"className":["token","generics"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"<"}]},{"type":"element","tagName":"span","properties":{"className":["token","class-name"]},"children":[{"type":"text","value":"Tili"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":">"}]}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","function"]},"children":[{"type":"text","value":"findByIdNotNull"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":";"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"}"}]}]}]}]},{"type":"element","tagName":"programming-exercise","properties":{"name":"Names and Addresses","tmcname":"osa03-Osa03_05.NamesAndAddresses"},"children":[{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Tehtäväpohja sisältää sovelluksen, joka sisältää henkilöitä ja osoitteita. Jokainen henkilö asuu tietyssä osoitteessa ja osoitteessa voi asua useita henkilöitä. Sovelluksessa tulostetaan kaikki tietokannassa olevat henkilöt sekä heidän osoitteensa."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Tämän hetkinen ratkaisu ei ole kovin optimaalinen, sillä sovelluksen toteutuksessa on N+1 -kyselyn ongelma."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Korjaa ongelma. Muokkaa sovellusta siten, että henkilöiden ja heidän osoitteidensa tulostaminen tapahtuu sovelluksessa yhdellä SQL-kyselyllä."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Tehtävässä ei ole testejä. Mielenkiintoisesti omalla koneella testattaessa voi käydä niin, ettei hitautta huomaa — huomaat ongelman vähintäänkin sovelluksen lokeista."}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Tarkastellaan seuraavaksi mistä tämä "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"findByIdNotNull"}]},{"type":"text","value":" oikeastaan tuleekaan..."}]}]},"html":"<div><text-box variant='learningObjectives' name='Oppimistavoitteet'><ul>\n<li>Tiedät mitä N+1 -kyselyn ongelma tarkoittaa.</li>\n<li>Osaat antaa esimerkkejä tilanteista, joissa N+1 -kyselyn ongelma voi esiintyä.</li>\n<li>Tunnet menetelmiä N+1 -kyselyn ongelman kiertämiseen.</li>\n<li>Tunnet tietokantakyselyiden ohjeistamiseen käytetyt annotaatiot <code class=\"language-text\">@EntityGraph</code> ja <code class=\"language-text\">@NamedEntityGraph</code> ja olet kokeillut niiden käyttöä.</li>\n</ul></text-box><p>Tietokanta-abstraktioita tarjoavat kirjastot päättävät miten haettavaan olioon liittyvät viitteet haetaan. Perinteisesti tähän on ollut käytössä kaksi vaihtoehtoa: (1) haetaan viitatut oliot samalla kun viittaavaa oliota haetaan, ja (2) hakea viitatut oliot vasta kun niitä pyydetään eksplisiittisesti esimerkiksi olion get-metodin kautta.</p><p>Viitattujen olioiden lataaminen vasta niitä tarvittaessa on yleisesti ottaen hyvä idea, mutta sillä on myös kääntöpuolensa.</p><p>Pohditaan pankkijärjestelmäämme, missä henkilöllä voi olla monta tiliä, ja yhdellä tilillä voi olla monta omistajaa — <code class=\"language-text\">@ManyToMany</code>.</p><p>Luodaan sovellukseen sivu, joka tulostaa jokaisen tilin yhteydessä tilin omistajien lukumäärän. Kontrollerin puolella toteutus on helppo — haemme tilit tietokannasta ja lisäämme ne modeliin.</p><div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">model<span class=\"token punctuation\">.</span><span class=\"token function\">addAttribute</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"tilit\"</span><span class=\"token punctuation\">,</span> tiliRepository<span class=\"token punctuation\">.</span><span class=\"token function\">findAll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div><p>HTML-sivullakin toteutus on suhteellisen suoraviivainen.</p><div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>h1</span><span class=\"token punctuation\">></span></span>Tilit<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>h1</span><span class=\"token punctuation\">></span></span>\n\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>ul</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>li</span> <span class=\"token attr-name\"><span class=\"token namespace\">th:</span>each</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>tili: ${tilit}<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>a</span> <span class=\"token attr-name\"><span class=\"token namespace\">th:</span>href</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>@{/tilit/{id}(id=${tili.id})}<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n            Tili: <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>span</span> <span class=\"token attr-name\"><span class=\"token namespace\">th:</span>text</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>${tili.id}<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>tilin id<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>span</span><span class=\"token punctuation\">></span></span>,\n            Saldo: <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>span</span> <span class=\"token attr-name\"><span class=\"token namespace\">th:</span>text</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>${tili.saldo}<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>saldo<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>span</span><span class=\"token punctuation\">></span></span>,\n            Omistajia <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>span</span> <span class=\"token attr-name\"><span class=\"token namespace\">th:</span>text</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>${tili.omistajat.size()}<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>lukumäärä<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>span</span><span class=\"token punctuation\">></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>a</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>li</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>ul</span><span class=\"token punctuation\">></span></span></code></pre></div><p>Kun haemme kontrollerissa tilit, sovellus tekee yhden tietokantakyselyn. Kun tulostamme tiliin liittyvien omistajien lukumäärän, tulee omistajat hakea. Tämä tehdään tilikohtaisesti <code class=\"language-text\">th:each=&quot;tili: ${tilit}&quot;</code>, joten kyselyitä tehdään yksi jokaista tiliä kohden. Tätä ongelmaa, missä näennäisesti yksinkertainen tiedon näyttäminen paisuu isoksi joukoksi tietokantakyselyitä kutsutaan N+1 -kyselyn ongelmaksi — ongelmassa tehdään N-kyselyä alkuperäisen yhden kyselyn lisäksi.</p><p>Ongelman voi ratkaista useammalla tavalla:</p><ul>\n<li>Ensimmäinen ratkaisu on poistaa N+1 -kyselyn ongelman aiheuttava osa sovelluksestamme — kuinka tärkeää on näyttää tilin omistajien lukumäärä?</li>\n<li>Toinen ratkaisu on denormalisoida tietokantaa hieman, jolloin tauluun Tili lisättäisiin oma sarake omistajien lukumäärälle — tämä vaatisi uuden sarakkeen tiedon ylläpidot automaattisesti.</li>\n<li>Kolmas ratkaisu on toteuttaa sivulle erillinen kysely, joka hakee sekä tilit että tilin omistajien lukumäärän — tietokanta-abstraktio ei tiedä että haluamme vain omistajien lukumäärän, joten se yrittää hakea kaikki tiedot; yksinkertainen yhteenvetokysely ajaisi täysin saman asian.</li>\n<li>Neljäs vaihtoehto — joka on tulossa yhä suositummaksi — on käyttää ns. Entity Grapheja kyselyssä, joiden avulla voidaan määritellä tarkemmin mitä haetaan.</li>\n</ul><br/><div>Sovelluksen ennenaikaiseen optimointiin ei kuitenkaan kannata käyttää aikaa — ongelmat kannattaa korjata sitä mukaa kun niitä kohdataan. <a href=\"https://en.wikipedia.org/wiki/Donald_Knuth\" target=\"_blank\">Knuthin</a> sanoin, <em>Programmers waste enormous amounts of time thinking about, or worrying about, the speed of noncritical parts of their programs, and these attempts at efficiency actually have a strong negative impact when debugging and maintenance are considered. We should forget about small efficiencies, say about 97% of the time: premature optimization is the root of all evil. Yet we should not pass up our opportunities in that critical 3%.</em></div><br/><p>Miten sitten N+1 -kyselyn oikein tunnistaa ohjelmasta? Yksinkertaisin tapa on tarkastella tietokantaan tehtyjä kyselyitä. Spring tulostaa konsoliin käytetyt SQL-kyselyt kun lisäämällä projektin kansiossa <code class=\"language-text\">src/main/resources</code> olevaan konfiguraatiotiedostoon <code class=\"language-text\">application.properties</code> seuraavan rivin.</p><div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">spring.jpa.show-sql=true</code></pre></div><p>Nyt, kun sovellus on käynnissä, sovelluksessa tehdyt tietokantakyselyt tulostetaan ohjelman lokiin. Esimerkiksi yllä olevan sivun hakeminen tuottaa lokiin seuraavanlaiset kyselyt — esimerkissämme tietokannassa on neljä tiliä:</p><div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Hibernate: select tili0_.id as id1_4_, tili0_.pankki_id as pankki_i3_4_, tili0_.saldo as saldo2_4_ from tili tili0_\nHibernate: select omistajat0_.tilit_id as tilit_id2_1_0_, omistajat0_.omistajat_id as omistaja1_1_0_, henkilo1_.id as id1_0_1_, henkilo1_.nimi as nimi2_0_1_ from henkilo_tilit omistajat0_ inner join henkilo henkilo1_ on omistajat0_.omistajat_id=henkilo1_.id where omistajat0_.tilit_id=?\nHibernate: select omistajat0_.tilit_id as tilit_id2_1_0_, omistajat0_.omistajat_id as omistaja1_1_0_, henkilo1_.id as id1_0_1_, henkilo1_.nimi as nimi2_0_1_ from henkilo_tilit omistajat0_ inner join henkilo henkilo1_ on omistajat0_.omistajat_id=henkilo1_.id where omistajat0_.tilit_id=?\nHibernate: select omistajat0_.tilit_id as tilit_id2_1_0_, omistajat0_.omistajat_id as omistaja1_1_0_, henkilo1_.id as id1_0_1_, henkilo1_.nimi as nimi2_0_1_ from henkilo_tilit omistajat0_ inner join henkilo henkilo1_ on omistajat0_.omistajat_id=henkilo1_.id where omistajat0_.tilit_id=?\nHibernate: select omistajat0_.tilit_id as tilit_id2_1_0_, omistajat0_.omistajat_id as omistaja1_1_0_, henkilo1_.id as id1_0_1_, henkilo1_.nimi as nimi2_0_1_ from henkilo_tilit omistajat0_ inner join henkilo henkilo1_ on omistajat0_.omistajat_id=henkilo1_.id where omistajat0_.tilit_id=?</code></pre></div><p>Lokissa nähdään ensin tilien hakeminen, jota seuraa tilien hakeminen yksitellen. Syntaksi on automaattisesti luotua SQL:ää ja voi näyttää hieman monimutkaiselta — tarkemmin tarkasteltuna kysely muuttuu tutuksi.</p><h4>EntityGraph</h4><p>Edellä kuvattiin muutamia vaihtoehtoja N+1 -kyselyn ongelman poistamiseksi. Tarkastellaan tässä neljättä vaihtoehtoa eli entity grapheja, jotka esiteltiin vuonna 2013 julkaistussa JPA 2.1 standardissa. Entity graphien avulla ohjelmoija voi määritellä kyselyn tuloksena haettavat oliot ym. tiedot.</p><div>Teemaan voi tarkemmin syventyä Spring Data JPA-projektin <a href=\"https://docs.spring.io/spring-data/jpa/docs/current/reference/html/\" target=\"_blank\">dokumentaatiossa</a> sekä mm. osoitteissa <a href=\"https://www.baeldung.com/jpa-entity-graph\" target=\"_blank\">https://www.baeldung.com/jpa-entity-graph</a> ja <a href=\"https://www.radcortez.com/jpa-entity-graphs/\" target=\"_blank\">https://www.radcortez.com/jpa-entity-graphs/</a>.</div><br/><p>Voimme korvata <code class=\"language-text\">JpaRepository</code>-luokan tarjoaman <code class=\"language-text\">findAll</code>-toteutuksen omalla metodillamme. Alla olevassa toteutuksessa kerrotaan, että haluamme hakea tilien yhteydessä myös tilien <code class=\"language-text\">omistajat</code>-muuttujaan liityvät tiedot.</p><div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">TiliRepository</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">JpaRepository</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Tili</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Long</span><span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@EntityGraph</span><span class=\"token punctuation\">(</span>attributePaths <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"omistajat\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Tili</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">findAll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div><br/><p>Kun tietokannasta tilit kutsulla <code class=\"language-text\">findAll</code>, sovellus hakee tilien yhteydessä myös omistajat.</p><div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Hibernate: select tili0_.id as id1_4_0_, henkilo2_.id as id1_0_1_, tili0_.pankki_id as pankki_i3_4_0_, tili0_.saldo as saldo2_4_0_, henkilo2_.nimi as nimi2_0_1_, omistajat1_.tilit_id as tilit_id2_1_0__, omistajat1_.omistajat_id as omistaja1_1_0__ from tili tili0_ left outer join henkilo_tilit omistajat1_ on tili0_.id=omistajat1_.tilit_id left outer join henkilo henkilo2_ on omistajat1_.omistajat_id=henkilo2_.id</code></pre></div><p>Mutta! (Ainakin Spring Bootin versiossa 2.1.3) Sovellus hakee nyt myös henkilöiden pankit, vaikkei niitä eksplisiittisesti tarvita. Edellinen muutos aiheuttaa jostain syystä uuden N+1 -kyselyn ongelman. Onneksi kyselyjen logitus oli päällä. Korjataan tilanne pienellä purkkaratkaisulla — pyydetään tilejä haettaessa myös tileihin liittyvät pankit.</p><div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">TiliRepository</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">JpaRepository</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Tili</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Long</span><span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@EntityGraph</span><span class=\"token punctuation\">(</span>attributePaths <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"omistajat\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"pankki\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Tili</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">findAll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div><p>Nyt kysely hakee myös tileihin liittyvät pankit.</p><div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Hibernate: select tili0_.id as id1_4_0_, henkilo2_.id as id1_0_1_, pankki3_.id as id1_3_2_, tili0_.pankki_id as pankki_i3_4_0_, tili0_.saldo as saldo2_4_0_, henkilo2_.nimi as nimi2_0_1_, omistajat1_.tilit_id as tilit_id2_1_0__, omistajat1_.omistajat_id as omistaja1_1_0__, pankki3_.nimi as nimi2_3_2_ from tili tili0_ left outer join henkilo_tilit omistajat1_ on tili0_.id=omistajat1_.tilit_id left outer join henkilo henkilo2_ on omistajat1_.omistajat_id=henkilo2_.id left outer join pankki pankki3_ on tili0_.pankki_id=pankki3_.id</code></pre></div><h4>NamedEntityGraph</h4><p>Yllä olevassa esimerkissä korvasimme <code class=\"language-text\">JpaRepository</code>-rajapinnan tarjoaman metodin. EntityGraphin voi määritellä myös osaksi entiteettiä annotaation <code class=\"language-text\">@NamedEntityGraph</code> avulla. Yllä olevan kyselyn voi toteuttaa myös seuraavalla tavalla.</p><p>Alla luokalle <code class=\"language-text\">Tili</code> on määritelty kysely <code class=\"language-text\">Tili.omistajatJaPankit</code>, joka hakee tilin haun yhteydessä omistajat ja pankit. Toiminnallisuus on käytännössä identtinen edellisen toteutuksemme kanssa.</p><div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@NamedEntityGraph</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"Tili.omistajatJaPankit\"</span><span class=\"token punctuation\">,</span>\n  attributeNodes <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token annotation punctuation\">@NamedAttributeNode</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"omistajat\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token annotation punctuation\">@NamedAttributeNode</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"pankki\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token annotation punctuation\">@Entity</span>\n<span class=\"token annotation punctuation\">@Data</span> <span class=\"token annotation punctuation\">@NoArgsConstructor</span> <span class=\"token annotation punctuation\">@AllArgsConstructor</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Tili</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">AbstractPersistable</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Long</span><span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">BigDecimal</span> saldo <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">BigDecimal</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@ManyToOne</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Pankki</span> pankki<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@ManyToMany</span><span class=\"token punctuation\">(</span>mappedBy <span class=\"token operator\">=</span> <span class=\"token string\">\"tilit\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Henkilo</span><span class=\"token punctuation\">></span></span> omistajat <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ArrayList</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token punctuation\">}</span></code></pre></div><p>Luokkaan <code class=\"language-text\">Tili</code> määritellyn kyselyn käyttäminen tapahtuu <code class=\"language-text\">JpaRepository</code>-rajapinnassa seuraavasti. Korvaamme yhä aiemman <code class=\"language-text\">findAll</code>-metodin, mutta toisin kuin aiemmin, kerromme kyselyn sijaan kyselyn nimen eli <code class=\"language-text\">Tili.omistajatJaPankit</code>.</p><div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">TiliRepository</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">JpaRepository</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Tili</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Long</span><span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@EntityGraph</span><span class=\"token punctuation\">(</span>value <span class=\"token operator\">=</span> <span class=\"token string\">\"Tili.omistajatJaPankit\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Tili</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">findAll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div><p>Tilanne ei ole vieläkään ihanteellinen, sillä korvaamme metodin <code class=\"language-text\">findAll</code>. Jossain muualla metodia saatetaan haluta käyttää ilman, että tilien hakemisen yhteydessä haetaan tilin omistajat ja pankit. Yksi vaihtoehto on toteuttaa erillinen metodi — vaikkapa <code class=\"language-text\">findByIdNotNull</code> — joka ajaa saman asian.</p><div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">TiliRepository</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">JpaRepository</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Tili</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Long</span><span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@EntityGraph</span><span class=\"token punctuation\">(</span>value <span class=\"token operator\">=</span> <span class=\"token string\">\"Tili.omistajatJaPankit\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Tili</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">findByIdNotNull</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div><programming-exercise name='Names and Addresses' tmcname='osa03-Osa03_05.NamesAndAddresses'><p>Tehtäväpohja sisältää sovelluksen, joka sisältää henkilöitä ja osoitteita. Jokainen henkilö asuu tietyssä osoitteessa ja osoitteessa voi asua useita henkilöitä. Sovelluksessa tulostetaan kaikki tietokannassa olevat henkilöt sekä heidän osoitteensa.</p><p>Tämän hetkinen ratkaisu ei ole kovin optimaalinen, sillä sovelluksen toteutuksessa on N+1 -kyselyn ongelma.</p><p>Korjaa ongelma. Muokkaa sovellusta siten, että henkilöiden ja heidän osoitteidensa tulostaminen tapahtuu sovelluksessa yhdellä SQL-kyselyllä.</p><p>Tehtävässä ei ole testejä. Mielenkiintoisesti omalla koneella testattaessa voi käydä niin, ettei hitautta huomaa — huomaat ongelman vähintäänkin sovelluksen lokeista.</p></programming-exercise><p>Tarkastellaan seuraavaksi mistä tämä <code class=\"language-text\">findByIdNotNull</code> oikeastaan tuleekaan...</p></div>","frontmatter":{"path":"/osa-3/3-n-plus-1-kyselyn-ongelma","title":"N+1 kyselyn ongelma"}},"allPages":{"edges":[{"node":{"id":"3283b622-bc08-5a19-9f02-6e3db5b31a9e","frontmatter":{"path":"/arvostelu-ja-kokeet","title":"Arvostelu ja kokeet"}}},{"node":{"id":"e78c9ef5-d275-5bf5-a509-1b9e4c75d71d","frontmatter":{"path":"/ilmoittautuminen","title":"Ilmoittautuminen"}}},{"node":{"id":"76068d63-4a30-5f9e-9efd-ed49edc98b6a","frontmatter":{"path":"/","title":"Tietoa kurssista"}}},{"node":{"id":"61df2549-c6f5-5c67-8b7f-8e9b179914c7","frontmatter":{"path":"/projekti","title":"Projekti"}}},{"node":{"id":"e771e805-db54-5575-a454-bd4c2716760b","frontmatter":{"path":"/osaamistavoitteet","title":"Osaamistavoitteet"}}},{"node":{"id":"5382499e-39f1-5cd3-b8dd-db9394113dd6","frontmatter":{"path":"/tukivaylat","title":"Tukiväylät"}}},{"node":{"id":"da046513-cc80-52ea-982b-6ba29eb36c6f","frontmatter":{"path":"/usein-kysytyt-kysymykset","title":"Usein kysytyt kysymykset"}}},{"node":{"id":"079e1fa2-0d02-5126-86d9-476aff42030b","frontmatter":{"path":"/ekstra/ajan-kasittely-tietokannassa","title":"Ajan käsittely tietokannassa"}}},{"node":{"id":"1af05bdb-9079-516d-be98-e23b12502041","frontmatter":{"path":"/ekstra/tietokantamigraatiot","title":"Tietokantamigraatiot"}}},{"node":{"id":"249178b9-973e-51fb-9b2e-6f9ce2dd2caa","frontmatter":{"path":"/osa-1/1-internetin-perusosat","title":"Internetin perusosat"}}},{"node":{"id":"d3789e1a-41d9-5c85-91ca-f0409e886900","frontmatter":{"path":"/osa-1/2-web-palvelimen-toiminta","title":"Web-palvelimen toiminta"}}},{"node":{"id":"5713905a-c5d4-5ecd-a8ea-115c942d7074","frontmatter":{"path":"/osa-1/3-spring-sovelluskehys","title":"Spring-sovelluskehys"}}},{"node":{"id":"466c1a97-6994-5173-bb91-61d05a30526b","frontmatter":{"path":"/osa-1/4-yhteenveto","title":"Yhteenveto"}}},{"node":{"id":"17d35c69-fc92-51be-bc33-4fc9ae222cde","frontmatter":{"path":"/osa-1","title":"Osa 1"}}},{"node":{"id":"3a940cd3-4bbf-51fd-ac1c-41aa09ff32d5","frontmatter":{"path":"/osa-2/1-nakymat-ja-data","title":"Näkymät ja data"}}},{"node":{"id":"bf989dd9-3412-5c74-884a-da6bb6aaac93","frontmatter":{"path":"/osa-2/2-tiedon-lahettaminen-palvelimelle","title":"Tiedon lähettäminen palvelimelle"}}},{"node":{"id":"e291213c-4b28-5f9d-b2e1-54f7d4dbe816","frontmatter":{"path":"/osa-2/3-tietokantojen-kasittely","title":"Tietokantojen käsittely ohjelmallisesti"}}},{"node":{"id":"30ad81c1-8b76-597c-9c62-751757da310b","frontmatter":{"path":"/osa-2/4-polkumuuttujat","title":"Polkumuuttujat"}}},{"node":{"id":"89a245a1-75c1-54b3-a601-672bbd9ec262","frontmatter":{"path":"/osa-2/5-yhteenveto","title":"Yhteenveto"}}},{"node":{"id":"cbe2bc5a-cc26-5910-9f4d-b044ec47abd3","frontmatter":{"path":"/osa-2","title":"Osa 2"}}},{"node":{"id":"b7817525-1953-521b-9e58-8a26d3665534","frontmatter":{"path":"/osa-3/1-useampi-tietokantataulu","title":"Useampi tietokantataulu ja taulujen väliset viitteet"}}},{"node":{"id":"6b7162fe-46bd-56fa-a8d2-41b0781f1c23","frontmatter":{"path":"/osa-3/2-tietokantatransaktiot","title":"Tietokantatransaktiot"}}},{"node":{"id":"7fcb1b86-738d-543a-a2bb-56119be2850c","frontmatter":{"path":"/osa-3/3-n-plus-1-kyselyn-ongelma","title":"N+1 kyselyn ongelma"}}},{"node":{"id":"c15b1320-b951-59b3-86b4-b647e04a54b8","frontmatter":{"path":"/osa-3/4-tulosten-rajaaminen-ja-jarjestaminen","title":"Tietokantakyselyiden tulosten rajaaminen ja järjestäminen"}}},{"node":{"id":"0ea05616-b6f5-54e2-8045-4a86c7c0b197","frontmatter":{"path":"/osa-3/5-yhteenveto","title":"Yhteenveto"}}},{"node":{"id":"8eff6b69-a4e1-5bfb-8d86-f93e7eef7978","frontmatter":{"path":"/osa-3","title":"Osa 3"}}},{"node":{"id":"22ccbbfe-8a60-5d30-a898-e2da567da345","frontmatter":{"path":"/osa-4/1-mediatyyppi-ja-tiedostojen-kasittely","title":"Mediatyyppi ja tiedostojen käsittely"}}},{"node":{"id":"cfcd1e2d-d678-502f-bc30-5ce24a9a29cd","frontmatter":{"path":"/osa-4/2-ohjelmistokehitysprosessi","title":"Muutama sana ohjelmistokehityksestä"}}},{"node":{"id":"2159f129-bc50-5474-97a7-e67d45a13742","frontmatter":{"path":"/osa-4/3-sovelluksen-rakenne","title":"Sovelluksen rakenne"}}},{"node":{"id":"382343a9-8806-5fc7-8c06-2cc69689b180","frontmatter":{"path":"/osa-4/4-konfiguraatioprofiilit","title":"Konfiguraatioprofiilit"}}},{"node":{"id":"708d8201-7107-566a-a74f-4b56444dcd0b","frontmatter":{"path":"/osa-4/5-sovellusten-testaaminen","title":"Sovellusten testaaminen"}}},{"node":{"id":"db8df001-8629-5e13-be04-df87d1afc2b7","frontmatter":{"path":"/osa-4/6-sovelluksen-siirtaminen-pilvipalveluun","title":"Sovelluksen siirtäminen pilvipalveluun"}}},{"node":{"id":"89ca7162-20da-5868-a3eb-5c973045856b","frontmatter":{"path":"/osa-4/7-yhteenveto","title":"Yhteenveto"}}},{"node":{"id":"582a5c8b-beca-5122-a87a-f2cb9068d18a","frontmatter":{"path":"/osa-4","title":"Osa 4"}}},{"node":{"id":"67422910-7142-56bb-80a6-cbd73f7461d3","frontmatter":{"path":"/osa-5/1-http-protokollan-tilattomuus-ja-evasteet","title":"HTTP-protokollan tilattomuus ja evästeet"}}},{"node":{"id":"c65c7fed-73a9-537f-b5f1-3241761326e3","frontmatter":{"path":"/osa-5/2-autentikaatio-ja-auktorisointi","title":"Autentikaatio ja auktorisointi"}}},{"node":{"id":"0428fec4-6ca3-527b-855a-bb3397e65d8c","frontmatter":{"path":"/osa-5/3-nakymatason-ja-metoditason-auktorisointi","title":"Näkymä- ja metoditason auktorisointi"}}},{"node":{"id":"dd6b12f5-d1ee-54b2-af79-f6f6963f8336","frontmatter":{"path":"/osa-5/4-yhteenveto","title":"Yhteenveto"}}},{"node":{"id":"62ff299a-8fe5-58fc-a1f3-010a9ca8ff9d","frontmatter":{"path":"/osa-5","title":"Osa 5"}}},{"node":{"id":"e2bfad01-9334-5cdb-88d1-6509e74db429","frontmatter":{"path":"/osa-6/1-toistuvat-rakenteet-html-sivuilla","title":"Toistuvat rakenteet HTML-sivuilla"}}},{"node":{"id":"59b114a1-6e99-515f-861c-c344839f5f6b","frontmatter":{"path":"/osa-6/2-tyylitiedostot-ja-asettelu","title":"Tyylitiedostot ja sivun asettelun määrittely"}}},{"node":{"id":"3d0269f8-2809-565c-9284-f15ab30559a1","frontmatter":{"path":"/osa-6/3-syotteiden-validointi","title":"Syötteiden validointi"}}},{"node":{"id":"65746c76-9e0b-5c1e-8388-589c3d895db8","frontmatter":{"path":"/osa-6/4-rajapinnat-ja-rest","title":"Rajapinnat ja REST"}}},{"node":{"id":"6c0caa0b-e5f4-5818-b2d0-602f51175ffe","frontmatter":{"path":"/osa-6/5-yhteenveto","title":"Yhteenveto"}}},{"node":{"id":"87285c75-6058-5ed6-af3a-67835f2e9758","frontmatter":{"path":"/osa-6","title":"Osa 6"}}},{"node":{"id":"1edfd6c7-3880-5e94-b639-6c9d80ff7d14","frontmatter":{"path":"/osa-7/1-selainohjelmistot-ja-javascript","title":"Selainohjelmistot ja JavaScript"}}},{"node":{"id":"7c1c61e3-b3e5-5b18-88ab-571ea9f529b8","frontmatter":{"path":"/osa-7/2-tietoturva","title":"Muutama sana tietoturvasta"}}},{"node":{"id":"457aeff4-3970-5308-88c0-cbadc4c4da14","frontmatter":{"path":"/osa-7/3-sovellusten-skaalautuminen","title":"Isommille käyttäjämäärille skaalautuvat sovellukset"}}},{"node":{"id":"40649dd6-c843-59b5-b08b-2ffe5344119c","frontmatter":{"path":"/osa-7/4-reaktiivinen-ohjelmointi","title":"Reaktiivinen ohjelmointi"}}},{"node":{"id":"a1a0b842-6a0f-5dc5-835a-7b47ef681fe4","frontmatter":{"path":"/osa-7/5-yhteenveto","title":"Yhteenveto"}}},{"node":{"id":"a7e70d0e-5b2d-52f5-a5e8-5b9e6fd90aa8","frontmatter":{"path":"/osa-7","title":"Osa 7"}}},{"node":{"id":"8d82aaf9-de05-5ae7-a886-7e21e8781ae3","frontmatter":{"path":"/osa-x/x-johdanto","title":"Johdanto"}}}]}},"pageContext":{}},"staticQueryHashes":["2929037737","994120085"]}